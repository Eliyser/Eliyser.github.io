<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器 | never belief any book | love youself,love life</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#F98A8A">
    
    
    <meta name="keywords" content="">
    <meta name="description" content="依赖 shiro-web &amp;lt;!--shiro项目至少的jar--&amp;gt; &amp;lt;dependency&amp;gt;     &amp;lt;groupId&amp;gt;org.apache.shiro&amp;lt;/groupId&amp;gt;     &amp;lt;artifactId&amp;gt;shiro-core&amp;lt;/artifactId&amp;gt;     &amp;lt;version&amp;gt;1.2.2&amp;lt;/version&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器">
<meta property="og:url" content="http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/index.html">
<meta property="og:site_name" content="never belief any book">
<meta property="og:description" content="依赖 shiro-web &amp;lt;!--shiro项目至少的jar--&amp;gt; &amp;lt;dependency&amp;gt;     &amp;lt;groupId&amp;gt;org.apache.shiro&amp;lt;/groupId&amp;gt;     &amp;lt;artifactId&amp;gt;shiro-core&amp;lt;/artifactId&amp;gt;     &amp;lt;version&amp;gt;1.2.2&amp;lt;/version&amp;">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://zhuzhuzai.oss-cn-shenzhen.aliyuncs.com/00e16ed3-afea-3614-926c-bdc2b09d5d8e.png">
<meta property="og:updated_time" content="2019-05-03T09:08:17.983Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器">
<meta name="twitter:description" content="依赖 shiro-web &amp;lt;!--shiro项目至少的jar--&amp;gt; &amp;lt;dependency&amp;gt;     &amp;lt;groupId&amp;gt;org.apache.shiro&amp;lt;/groupId&amp;gt;     &amp;lt;artifactId&amp;gt;shiro-core&amp;lt;/artifactId&amp;gt;     &amp;lt;version&amp;gt;1.2.2&amp;lt;/version&amp;">
<meta name="twitter:image" content="http://zhuzhuzai.oss-cn-shenzhen.aliyuncs.com/00e16ed3-afea-3614-926c-bdc2b09d5d8e.png">
    
        <link rel="alternate" type="application/atom+xml" title="never belief any book" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/logo.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Haien</h5>
          <a href="mailto:1410343862@qq.com" title="1410343862@qq.com" class="mail">1410343862@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/Eliyser" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/custom"  >
                <i class="icon icon-lg icon-link"></i>
                测试
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-04-30T08:29:23.009Z" itemprop="datePublished" class="page-time">
  2019-04-30
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#依赖"><span class="post-toc-number">1.</span> <span class="post-toc-text">依赖</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#web-xml配置、ShiroFilter"><span class="post-toc-number">2.</span> <span class="post-toc-text">web.xml配置、ShiroFilter</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#常用的身份验证"><span class="post-toc-number">3.</span> <span class="post-toc-text">常用的身份验证</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#基于Basic的拦截器身份验证"><span class="post-toc-number">4.</span> <span class="post-toc-text">基于Basic的拦截器身份验证</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#基于表单的拦截器身份验证"><span class="post-toc-number">5.</span> <span class="post-toc-text">基于表单的拦截器身份验证</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#权限验证"><span class="post-toc-number">6.</span> <span class="post-toc-text">权限验证</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#代码实例"><span class="post-toc-number">7.</span> <span class="post-toc-text">代码实例</span></a></li></ol>
        </nav>
    </aside>


<article id="post-Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-04-30 16:29:23" datetime="2019-04-30T08:29:23.009Z"  itemprop="datePublished">2019-04-30</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><ul>
<li><p>shiro-web</p>
<pre><code>&lt;!--shiro项目至少的jar--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;
    &lt;artifactId&gt;shiro-core&lt;/artifactId&gt;
    &lt;version&gt;1.2.2&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;
    &lt;artifactId&gt;shiro-web&lt;/artifactId&gt;
    &lt;version&gt;1.2.2&lt;/version&gt;
&lt;/dependency&gt;
</code></pre></li>
<li><p>Servlet3:编译与测试时的web环境</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
    &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;
    &lt;version&gt;3.0.1&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre></li>
<li><p>tomcat7-maven-plugin插件: 运行时的web环境</p>
<pre><code>&lt;build&gt;
    &lt;finalName&gt;shiroHelloWorld-chapter7&lt;/finalName&gt;
      &lt;plugins&gt;
          &lt;plugin&gt;
              &lt;groupId&gt;org.apache.tomcat.maven&lt;/groupId&gt;
              &lt;artifactId&gt;tomcat7-maven-plugin&lt;/artifactId&gt;
              &lt;version&gt;2.2&lt;/version&gt;
              &lt;configuration&gt;
                  &lt;path&gt;/${project.build.finalName}&lt;/path&gt;
              &lt;/configuration&gt;
          &lt;/plugin&gt;
      &lt;/plugins&gt;
&lt;/build&gt;
</code></pre></li>
</ul>
<h3 id="web-xml配置、ShiroFilter"><a href="#web-xml配置、ShiroFilter" class="headerlink" title="web.xml配置、ShiroFilter"></a>web.xml配置、ShiroFilter</h3><ul>
<li>Shiro提供了与web的集成，通过一个ShiroFilter入口来拦截需要安全控制的url，默认实现类是IniShiroFilter。</li>
<li><p>shiro 1.1版本的ShiroFilter：</p>
<pre><code>&lt;filter&gt;
    &lt;filter-name&gt;iniShiroFilter&lt;/filter-name&gt; &lt;!--使用IniShiroFilter作为shiro安全控制入口点--&gt;
    &lt;filter-class&gt;org.apache.shiro.web.servlet.IniShiroFilter&lt;/filter-class&gt;

    &lt;init-param&gt;
        &lt;param-name&gt;configPath&lt;/param-name&gt; &lt;!--configPath：指定ini配置文件位置；固定--&gt;
        &lt;param-value&gt;classpath:shiro.ini&lt;/param-value&gt; &lt;!--默认先从/WEB-INF/shiro.ini加载，
            没有再classpath：shiro.ini--&gt;
    &lt;/init-param&gt;
    &lt;!-- 或不指定ini位置，直接按下面这样
    &lt;init-param&gt;
        &lt;param-name&gt;config&lt;/param-name&gt;
        &lt;param-value&gt;
            [main]
            authc.loginUrl=/login
            [users]
            zhang=123,admin
            [roles]
            admin=user:*,menu:*
            [urls]
            /login=anon
            /static/**=anon
            /authenticated=authc
            /role=authc,roles[admin]
            /permission=authc,perms[&quot;user:create&quot;]
        &lt;/param-value&gt;
    &lt;/init-param&gt;
    --&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
    &lt;filter-name&gt;iniShiroFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt; &lt;!--指定需要拦截的url--&gt;
&lt;/filter-mapping&gt;
</code></pre></li>
<li>使用IniShiroFilter作为Shiro安全控制的入口点。</li>
<li>可以使用configPath指定ini配置文件路径，默认先从/WEB-INF/shiro.ini加载（/表示根目录，为webapp），没有再是classpath:shiro.ini。也可以直接内嵌配置文件内容。</li>
<li><p>shiro 1.2版本开始引入Environment/WebEnvironment，由它们的实现类提供相应的SecurityManager及其相应的依赖。ShiroFilter会自动找到Environment然后获取相应依赖。</p>
<pre><code>&lt;listener&gt;
    &lt;!--通过EnvironmentLoaderListener创建相应的WebEnvironment，并自动绑定到ServletContext，
    默认使用IniWebEnvironment实现类。--&gt;
    &lt;listener-class&gt;org.apache.shiro.web.env.EnvironmentLoaderListener&lt;/listener-class&gt;
&lt;/listener&gt;

&lt;!--可通过如下配置修改默认配置--&gt;
&lt;context-param&gt;
    &lt;param-name&gt;shiroEnvironmentClass&lt;/param-name&gt;
    &lt;param-value&gt;org.apache.shiro.web.env.IniWebEnvironment&lt;/param-value&gt;
&lt;/context-param&gt;
&lt;context-param&gt;
    &lt;param-name&gt;shiroConfigLocations&lt;/param-name&gt;
    &lt;param-value&gt;classpath:shiro.ini&lt;/param-value&gt; &lt;!--默认先/WEB-INF/shiro，没有再classpath:shiro.ini--&gt;
&lt;/context-param&gt;
</code></pre></li>
<li>以上俩版本的配置相当于以下代码：</li>
</ul>
<pre><code>//1、获取SecurityManager工厂，并使用ini配置文件初始化SecurityManager
Factory&lt;org.apache.shiro.mgt.SecurityManager&gt; factory=
          new IniSecurityManagerFactory(&quot;classpath:config/shiro.ini&quot;);
//2、得到SecurityManager实例，并绑定SecurityUtils
SecurityManager securityManager=factory.getInstance();
SecurityUtils.setSecurityManager(securityManager);
</code></pre><ul>
<li><p>那么以后登录直接从第3步：Subject subject=SecurityUtils.getSubject();写起。</p>
</li>
<li><p>与Spring集成：使用DelegatingFilterProxy，作用是自动到Spring容器查找名为filter-name的bean，并把所有Filter的操作委托给它，所以需要将shiroFilter注册到Spring。</p>
<pre><code>&lt;filter&gt;
    &lt;!--DelegatingFilterProxy作用是自动到Spring容器查找名为filter-name的bean，并把所有
    Filter的操作委托给它，所以需要将shiroFilter注册到Spring。--&gt;
    &lt;filter-name&gt;shiroFilter&lt;/filter-name&gt;
    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;

    &lt;!--可以不写--&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;targetFilterLifecycle&lt;/param-name&gt;
        &lt;param-value&gt;true&lt;/param-value&gt;
    &lt;/init-param&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
    &lt;filter-name&gt;shiroFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre></li>
<li><p>ShiroFilter的bean：主要是绑定SecurityManager。需要使用org.springframework.web.context.ContextLoaderListener加载所在配置文件。</p>
<pre><code>&lt;bean id=&quot;shiroFilter&quot; class=&quot;org.apache.shiro.spring.web.ShiroFilterFactoryBean&quot;&gt;
    &lt;property name=&quot;securityManager&quot; ref=&quot;securityManager&quot;/&gt;
    &lt;!—忽略其他，详见与Spring集成部分 --&gt;
&lt;/bean&gt;
</code></pre></li>
<li><p>如果不与Spring集成，则直接声明ShiroFilter即可：</p>
<pre><code>&lt;!--绑定SecurityManager--&gt;
&lt;filter&gt;
    &lt;filter-name&gt;shiroFilter&lt;/filter-name&gt;
    &lt;filter-class&gt;org.apache.shiro.web.servlet.ShiroFilter&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
    &lt;filter-name&gt;shiroFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre></li>
</ul>
<h3 id="常用的身份验证"><a href="#常用的身份验证" class="headerlink" title="常用的身份验证"></a>常用的身份验证</h3><ul>
<li>shiro.ini配置文件</li>
</ul>
<pre><code>[main]
#默认是/login.jsp
authc.loginUrl=/login #未登录会自动跳转登录页面
roles.unauthorizedUrl=/unauthorized
perms.unauthorizedUrl=/unauthorized

[users]
zhang=123,admin
wang=123

[roles]
admin=user:*,menu:*

[urls]
;格式：url=拦截器[参数]。anon拦截器表示匿名访问，无需登录；authc则需要登录；
;roles[admin]需要admin角色；perms[&quot;user:create&quot;]需要有user:create权限
/login=anon
/unauthorized=anon
/static/**=anon
/authenticated=authc
/role=authc,roles[admin]
/permission=authc,perms[&quot;user:create&quot;]
</code></pre><ul>
<li>urls格式：url=拦截器[参数]。anon拦截器表示匿名访问，无需登录，相当于不需拦截的资源；authc则需要登录;roles[admin]需要admin角色；perms[“user:create”]需要有user:create权限.</li>
<li><p>按照顺序进行匹配，只采用第一个匹配的进行拦截。</p>
</li>
<li><p>使用Ant风格模式</p>
<ul>
<li>?：匹配一个字符，如”/admin?”将匹配/admin1，但不匹配/admin或/admin2；</li>
<li><em>：匹配零个或多个字符串，如/admin</em>将匹配/admin、/admin123，但不匹配/admin/1；</li>
<li><strong>：匹配路径中的零个或多个路径，如/admin/</strong>将匹配/admin/a或/admin/a/b。</li>
</ul>
</li>
<li><p>接收到请求后，先到ini查看是否需要拦截，不需要则查找url匹配的servlet类，需要则在ini中查找登录的url，再查找匹配的servlet类。</p>
</li>
<li><p>LoginServlet：登录Servlet。get请求时展示登录页面；post请求进行登录验证。</p>
</li>
</ul>
<pre><code>//相当于web.xml配置&lt;servlet&gt;
@WebServlet(name=&quot;loginServlet&quot;,urlPatterns = &quot;/login&quot;) 
//url：http://localhost:8080/shiroHelloWorld-chapter7/login
public class LoginServlet extends HttpServlet {
    /**
     * @Author haien
     * @Description get请求时展示登录页面
     * @Date 2019/2/28
     * @Param [req, resp]
     * @return void
     **/
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {
        req.getRequestDispatcher(&quot;/jsp/login.jsp&quot;).forward(req,resp);
    }

    /**
     * @Author haien
     * @Description post请求进行登录验证
     * @Date 2019/2/28
     * @Param [req, resp]
     * @return void
     **/
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {
        String error = null;
        String username = req.getParameter(&quot;username&quot;);
        String password = req.getParameter(&quot;password&quot;);

        Subject subject = SecurityUtils.getSubject();
        UsernamePasswordToken token = new UsernamePasswordToken(username, password);
        try {
            subject.login(token);
        } catch (UnknownAccountException e) {
            error = &quot;用户名/密码错误&quot;;
        } catch (IncorrectCredentialsException e) {
            error = &quot;用户名/密码错误&quot;;
        } catch (AuthenticationException e) {
            //其他错误，比如锁定，如果想单独处理请单独catch处理
            error = &quot;其他错误：&quot; + e.getMessage();
        }
        if(error != null) {//出错了，返回登录页面
            req.setAttribute(&quot;error&quot;, error);
            req.getRequestDispatcher(&quot;/jsp/login.jsp&quot;).forward(req, resp);
        } else {//登录成功
            req.getRequestDispatcher(&quot;/jsp/loginSuccess.jsp&quot;).forward(req, resp);
        }
    }
}
</code></pre><ul>
<li>登录成功不能老是跳到成功页面，而是要跳到之前请求的页面，可以在登录时把当前请求保存下来，登录成功再重定向到该请求即可。</li>
</ul>
<h3 id="基于Basic的拦截器身份验证"><a href="#基于Basic的拦截器身份验证" class="headerlink" title="基于Basic的拦截器身份验证"></a>基于Basic的拦截器身份验证</h3><ul>
<li>同样是做安全控制的拦截器，但是它要求登录的方式不是跳转登录页面，而是弹出登录窗口。</li>
<li>shiro-basicfilterlogin.ini：</li>
</ul>
<pre><code>[main]
;authBasic是org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter类的实例，
;用于实现基于Basic的身份验证;applicationName属性显示在弹出的登录框
authcBasic.applicationName=please login

perms.unauthorizedUrl=/unauthorized
roles.unauthorizedUrl=/unauthorized
[users]
zhang=123,admin
wang=123

[roles]
admin=user:*,menu:*

[urls]
;/role需要走authcBasic拦截器，即如果访问/role时未登录则弹出对话框进行登录
/role=authcBasic,roles[admin]
</code></pre><ul>
<li>需要将web.xml中配置文件更改为shiro-basicfilterlogin.ini。</li>
<li>未登录访问/role将弹出窗口。再次测试未登录却没弹窗可能是因为Chrome记住了登录信息。</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://zhuzhuzai.oss-cn-shenzhen.aliyuncs.com/00e16ed3-afea-3614-926c-bdc2b09d5d8e.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<h3 id="基于表单的拦截器身份验证"><a href="#基于表单的拦截器身份验证" class="headerlink" title="基于表单的拦截器身份验证"></a>基于表单的拦截器身份验证</h3><ul>
<li>和第一种类似，但是更简单，因为已经实现了登录信息与用户库的匹配，我们只需要写登录页面的映射、登录失败处理即可。</li>
<li>原理大致如下，详情参见笔记：Shiro第八章二-自定义拦截器</li>
</ul>
<pre><code>public class FormLoginFilter extends PathMatchingFilter {
    private String loginUrl = &quot;/login.jsp&quot;;
    private String successUrl = &quot;/&quot;;

    /**
    * 总方法
    */
    @Override
    protected boolean onPreHandle(ServletRequest request, ServletResponse response, 
      Object mappedValue) throws Exception {

        //1、判断是否已登录，是则直接进入过滤链下一步
        if(SecurityUtils.getSubject().isAuthenticated()) {
            return true;//已经登录过
        }

        //2、未登录则判断是否为登录请求，是，则若是get请求，继续过滤链（跳转登录
        //页面），若是post请求，认为是表单验证请求，进行表单验证，执行subject.login()；
        //否，若是get方法的其他页面请求则保存当前请求并重定向到登录页面，非get请求可能报错吧
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        if(isLoginRequest(req)) { //是登录请求
            if(&quot;post&quot;.equalsIgnoreCase(req.getMethod())) { //form表单提交
                boolean loginSuccess = login(req); //登录
                if(loginSuccess) { //登录成功
                    return redirectToSuccessUrl(req, resp);
                }
            }

            //是get请求|登录失败，继续过滤器链，可能是被分配到controller处理/login
            return true;
        } 
        else { //不是登录请求，保存当前地址并重定向到登录界面
            saveRequestAndRedirectToLogin(req, resp);
            return false;
        }
    }

    /**
    * 登录成功后调用，若有之前的请求则重定向到它，否则到默认成功页面
    */
    private boolean redirectToSuccessUrl(HttpServletRequest req, 
        HttpServletResponse resp) throws IOException {
        WebUtils.redirectToSavedRequest(req, resp, successUrl);
        return false;
    }

    /**
    * 保存当前请求并跳转登录页面
    */
    private void saveRequestAndRedirectToLogin(HttpServletRequest req,
      HttpServletResponse resp) throws IOException {
        WebUtils.saveRequest(req);
        WebUtils.issueRedirect(req, resp, loginUrl);
    }

    /**
    * 表单验证，执行登录方法
    */
    private boolean login(HttpServletRequest req) {
        String username = req.getParameter(&quot;username&quot;);
        String password = req.getParameter(&quot;password&quot;);
        try {
            SecurityUtils.getSubject().login(new UsernamePasswordToken(username, password));
        } catch (Exception e) {
            req.setAttribute(&quot;shiroLoginFailure&quot;, e.getClass());
            return false;
        }
        return true;
    }

    /**
    * 判断是否登录请求
    */
    private boolean isLoginRequest(HttpServletRequest req) {
        return pathsMatch(loginUrl, WebUtils.getPathWithinApplication(req));
    }
}
</code></pre><ul>
<li>shiro-formfilterlogin.ini：</li>
</ul>
<pre><code>[main]
;authc是org.apache.shiro.web.filter.authc.FormAuthenticationFilter类的实例；
;loginUrl:指定登录地址、表单提交地址；successUrl：默认是/，
          如果有上一个地址会自动重定向到该地址；
;failureKeyAttribute：登录失败信息的在request中的key，默认为shiroLoginFailure，
                      内容为异常类型名。
authc.loginUrl=/formfilterlogin //get请求即为请求登录页面，由controller映射页面；
    post为表单验证请求，FormAuthenticationFilter处理
authc.usernameParam=username
authc.passwordParam=password
authc.successUrl=/
authc.failureKeyAttribute=shiroLoginFailure

perms.unauthorizedUrl=/unauthorized
roles.unauthorizedUrl=/unauthorized

[users]
zhang=123,admin
wang=123

[roles]
admin=user:*,menu:*

[urls]
/static/**=anon
/formfilterlogin=authc
/role=authc,roles[admin]
/permission=authc,perms[&quot;user:create&quot;]
</code></pre><ul>
<li><p>然后web.xml改为shiro-formfilterlogin.ini。</p>
</li>
<li><p>formfilterlogin.jsp：登录页面。</p>
<pre><code>&lt;body&gt;
    &lt;div class=&quot;error&quot;&gt;${error}&lt;/div&gt;
    &lt;form action=&quot;${pageContext.request.contextPath}/formfilterlogin&quot; method=&quot;post&quot;&gt;
        用户名：&lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;&lt;br/&gt;
        密码：&lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;&lt;br/&gt;
        &lt;input type=&quot;submit&quot; value=&quot;登录&quot;&gt;
    &lt;/form&gt;
&lt;/body&gt;
</code></pre></li>
<li><p>FormFilterLoginServlet：登录失败处理</p>
</li>
</ul>
<pre><code>@WebServlet(name = &quot;formFilterLoginServlet&quot;, urlPatterns = &quot;/formfilterlogin&quot;)
public class FormFilterLoginServlet extends HttpServlet {
    /**
     * @Author haien
     * @Description get请求的话FormAuthenticationFilter不做任何处理
     直接结束当前过滤链，进入下一过滤链，应该是Spring自己的过滤链了，
     应该就是分发给controller处理，所以这里应该是映射登录页面才对，不过交给doPost做
     也获取不到shiroLoginFailure，也是直接返回登录页面了
     * 
     * @Date 2019/3/15
     * @Param [req, resp]
     * @return void
     **/
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {
        doPost(req, resp);
    }

    /**
     * @Author haien
     * @Description 身份验证和成功跳转已被处理，如果失败FormAuthenticationFilter
     * 并不会返回登录页面或做任何处理，只是结束当前过滤链而进入下一过滤链，
     * 而下一过滤链应该就是Spring自己的过滤链，也就是将原请求分发到controller，
     * 所以要准备一个处理登录失败情况的跳转这里只处理失败情况
     * 
     * @Date 2019/2/28
     * @Param [req, resp]
     * @return void
     **/
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {
        String errorClassName = (String)req.getAttribute(&quot;shiroLoginFailure&quot;); //异常类型名
        if(UnknownAccountException.class.getName().equals(errorClassName)) {
            req.setAttribute(&quot;error&quot;, &quot;用户名/密码错误&quot;);
        } else if(IncorrectCredentialsException.class.getName().equals(errorClassName)) {
            req.setAttribute(&quot;error&quot;, &quot;用户名/密码错误&quot;);
        } else if(errorClassName != null) {
            req.setAttribute(&quot;error&quot;, &quot;未知错误：&quot; + errorClassName);
        }
        req.getRequestDispatcher(&quot;/jsp/formfilterlogin.jsp&quot;).forward(req, resp); //返回登录页面
    }
}
</code></pre><ul>
<li>测试：登录/role，会跳转/formfilterlogin登录页面，登陆成功会跳转/role而不是默认登录成功页面。</li>
</ul>
<h3 id="权限验证"><a href="#权限验证" class="headerlink" title="权限验证"></a>权限验证</h3><ul>
<li>shiro.ini</li>
</ul>
<pre><code>[main]
roles.unauthorizedUrl=/unauthorized
perms.unauthorizedUrl=/unauthorized
 [urls]
/role=authc,roles[admin]
/permission=authc,perms[&quot;user:create&quot;]
</code></pre><ul>
<li>unauthorizedUrl: 验证失败重定向到的地址。</li>
<li>roles: org.apache.shiro.web.filter.authz.RolesAuthorizationFilter类的实例，通过[参数]指定访问时需要的权限，如有多个使用”,”分隔，验证需要都通过。</li>
<li><p>perms：org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter类实例，验证权限字符串。</p>
</li>
<li><p>PermissionServlet类：只处理权限验证成功情况，失败情况ini已处理。</p>
</li>
</ul>
<pre><code>@WebServlet(name = &quot;permissionServlet&quot;, urlPatterns = &quot;/permission&quot;)
public class PermissionServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp)
      throws ServletException, IOException {
        Subject subject = SecurityUtils.getSubject();
        subject.checkPermission(&quot;user:create&quot;);
        req.getRequestDispatcher(&quot;/WEB-INF/jsp/hasPermission.jsp&quot;).forward(req, resp);
    }
}
</code></pre><ul>
<li>RoleServlet类：角色单位的权限验证，也是只处理成功情况，主要逻辑如下：</li>
</ul>
<pre><code>subject.checkRole(&quot;admin&quot;);
</code></pre><ul>
<li><p>测试：访问/login，使用zhang/123登录后访问/role或/permission，跳转授权成功页面；使用wang/123登录则跳转/unauthorized无授权页面。</p>
</li>
<li><p>Shiro也提供了logout拦截器用于退出，它是org.apache.shiro.web.filter.authc.LogoutFilter类的实例</p>
</li>
</ul>
<pre><code>[main]
;logout是org.apache.shiro.web.filter.authc.LogoutFilter类实例，Shiro内置logout拦截器
logout.redirectUrl=/login
[urls]
;指定退出url是/logout2；使用Shiro内置的logout拦截器退出，logout配置在上面main中
/logout2=logout
</code></pre><ul>
<li><p>则无需写Servlet类处理退出请求，只要把退出链接的url改成/logout2即可</p>
<pre><code>&lt;a href=&quot;${pageContext.request.contextPath}/logout2&quot;&gt;退出&lt;/a&gt;
</code></pre><h3 id="代码实例"><a href="#代码实例" class="headerlink" title="代码实例"></a>代码实例</h3></li>
<li>ideaProjects/shiroHelloWorldchapter7</li>
<li><a href="https://jinnianshilongnian.iteye.com/blog/2024723" target="_blank" rel="noopener">参考文章</a></li>
</ul>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-05-03T09:08:17.983Z" itemprop="dateUpdated">2019-05-03 17:08:17</time>
</span><br>


        
        这里可以写作者留言，标签和 hexo 中所有变量及辅助函数等均可调用，示例：<a href="/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/" target="_blank" rel="external">http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/</a>
        
    </div>
    
    <footer>
        <a href="http://47.107.237.149">
            <img src="/img/logo.jpg" alt="Haien">
            Haien
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            

            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/&title=《Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器》 — never belief any book&pic=http://47.107.237.149/img/logo.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/&title=《Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器》 — never belief any book&source=love youself,love life" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器》 — never belief any book&url=http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/&via=http://47.107.237.149" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/04/30/Shiro第三章二-授权示例/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Shiro第三章二-授权示例</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/04/30/Shiro第六章-各种对象详解-完整用户登录认证与授权示例/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Shiro第六章-各种对象详解-完整用户登录认证与授权示例</h4>
      </a>
    </div>
  
</nav>



    

















</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Haien &copy; 2015 - 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/&title=《Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器》 — never belief any book&pic=http://47.107.237.149/img/logo.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/&title=《Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器》 — never belief any book&source=love youself,love life" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器》 — never belief any book&url=http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/&via=http://47.107.237.149" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://47.107.237.149/2019/04/30/Shiro第七章-与web集成、ShiroFilter、基于表单的拦截器/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADNUlEQVR42u3ay27qUAwF0P7/T1PpjpBuCdt2kIizMkKUR9Zh4HrbPz/x9fh3PT9+vl49//zX/1/z6vlXn5nc28kXNjY29kXYj8Pr+KOr781fc9bnvzw4bGxs7HXspGhN2PnNHX9v8slRkcPGxsa+JfusZ6rHetzMYGNjY2NXC1g1MMr/2nsXNjY2NvakncgHA8nt5u+qjiiwsbGxd7N7g97vfPzx+TY2Njb2l7EfrWsSKiWBUR5s9RTY2NjYm9h5G5AvYibtxGjVpjU2iPohbGxs7AuyqysyVWozuC82GPnP8EfdxsbGxl7BTr5mMhjIm5nqqKDatBR+DWxsbOxLsZMC1lu46ZWc3sJQ3qJgY2Njb2Ln5eETSzNVWG9tCBsbG3s3e/5lZx1NMiquHt/LHxIbGxt7Hbs36O21MdWBRPK4GnthY2Njb2XnpSgpftW2ISmZ+fXmDrGxsbEXsasFqRdCzVdteoHXm7KHjY2NvYg92WaZxEy9dqU3fsDGxsbeyp4UmGoJyaOryfC48NtiY2NjL2LPx7HlL24dWX4ob+4BGxsbex27Gg/lYVD5hgbD3XyQgI2Njb2JXY3d5+Unv+nJUAEbGxv7PuzjkpA/nkRIx+DeMPjN67GxsbEXsXux/mTVZnKU1cN6U0qxsbGxV7DPKkuT6GfSojTjJ2xsbOx17GrJqeZVSSHshUfJ67GxsbHvwK6WonkU1RtCzJd+ylkaNjY29tezq3FPjslXeZImZDIYjrI0bGxs7Muye01FHkjlLUqvODVHC9jY2NiL2ElhmDQkk+Fx9Q7zUoqNjY29j92LeJLWIt8bOmtVKG9ysLGxsfexq0FPvu6Tl7Tq4eZLP1E3ho2NjX1xdi8qqv7TP6+xvWFw1IRgY2NjX5D9KF7z0Ke3uHNWgFUY9GJjY2NfhN0rAPM4Ph8Y99qV6oIRNjY29tXZ86JVDXp6xax60IWxLjY2NvYK9rwwVP/d/0jQX42WsLGxsW/JroY+k0FvfgTlOAkbGxv7luw83Km2E73RQv7J2NjY2HdgJ6FSL9bpDZJ7h54cPTY2NvY+djmOiV+fNDDzEpWMh09Y2cHGxsb+RvYvdoOM4PWEvVUAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '死鬼去哪里了！';
            clearTimeout(titleTime);
        } else {
            document.title = '(つェ⊂)咦!又好了!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
